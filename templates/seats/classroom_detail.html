{% extends 'base.html' %}
{% load static %}

{% block title %}{{ classroom.name }} - 排座详情{% endblock %}

{% block ribbon_tabs %}
<button type="button" class="ribbon-tab active" data-ribbon-tab="home">开始</button>
<button type="button" class="ribbon-tab" data-ribbon-tab="view">视图</button>
<button type="button" class="ribbon-tab" data-ribbon-tab="file">文件</button>
<button type="button" class="ribbon-tab" data-ribbon-tab="help">帮助</button>
<button type="button" class="ribbon-tab" data-ribbon-tab="class">班级</button>
{% endblock %}

{% block actions %}
<div class="ribbon-panels">
    <div class="header-action-row office-ribbon-row ribbon-panel active" data-ribbon-panel="home">
        <div class="ribbon-group">
            <form method="post" action="{% url 'auto_arrange_seats' classroom.pk %}" class="quick-arrange-form">
                {% csrf_token %}
                <select name="method" aria-label="自动排座算法">
                    <option value="random">随机排座</option>
                    <option value="score_desc">按成绩从高到低</option>
                    <option value="score_asc">按成绩从低到高</option>
                    <option value="good_front">成绩好的在前排</option>
                    <option value="good_back">成绩好的在后排</option>
                    <option value="score_spread">相邻成绩差异大</option>
                    <option value="group_balanced">小组均衡模式</option>
                    <option value="group_mentor">小组优带差模式</option>
                </select>
                <button class="btn btn-primary" id="btn-auto-arrange" type="submit">执行排座</button>
            </form>
            <span class="ribbon-group-label">排座</span>
        </div>
    </div>

    <div class="header-action-row office-ribbon-row ribbon-panel" data-ribbon-panel="view">
        <div class="ribbon-group">
            <a href="{% url 'layout_editor' classroom.pk %}" class="btn btn-secondary" id="btn-layout-editor">布局编辑</a>
            <button type="button" class="btn btn-secondary" onclick="toggleFullScreen()" id="btn-fullscreen">全屏</button>
            <span class="ribbon-group-label">视图</span>
        </div>
    </div>

    <div class="header-action-row office-ribbon-row ribbon-panel" data-ribbon-panel="file">
        <div class="ribbon-group">
            <button type="button" class="btn btn-secondary" id="btn-open-excel-import-modal"
                data-open-modal="excel-import-modal">导入 Excel 成绩表</button>
            <button type="button" class="btn btn-secondary" id="btn-open-seats-modal"
                data-open-modal="seats-file-modal">导入/导出 .seats</button>
            <button type="button" class="btn btn-secondary" id="btn-open-layout-import-modal"
                data-open-modal="seat-layout-import-modal">导入座位表</button>
            <span class="ribbon-group-label">导入导出</span>
        </div>
        <div class="ribbon-group">
            <a href="{% url 'export_students' classroom.pk %}" class="btn btn-secondary" id="btn-export">导出排座表</a>
            <a href="{% url 'export_group_report' classroom.pk %}" class="btn btn-secondary" id="btn-export-group-report">导出小组登记表</a>
            <span class="ribbon-group-label">导出</span>
        </div>
        <div class="ribbon-group">
            <button type="button" class="btn btn-secondary" data-open-side-tab="files" id="btn-open-files-tab">文件面板</button>
            <button type="button" class="btn btn-secondary" data-open-side-tab="constraints" id="btn-open-constraints-tab">约束管理</button>
            <span class="ribbon-group-label">面板</span>
        </div>
    </div>

    <div class="header-action-row office-ribbon-row ribbon-panel" data-ribbon-panel="help">
        <div class="ribbon-group">
            <button type="button" class="btn btn-secondary" onclick="startTour()" id="btn-tour">教程</button>
            <span class="ribbon-group-label">帮助</span>
        </div>
    </div>

    <div class="header-action-row office-ribbon-row ribbon-panel" data-ribbon-panel="class">
        <div class="ribbon-group ribbon-group-danger">
            <form method="post" action="{% url 'delete_classroom' classroom.pk %}" class="danger-inline-form"
                onsubmit="return confirm('确定要删除这个班级吗？');">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">删除班级</button>
            </form>
            <span class="ribbon-group-label">危险操作</span>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div id="classroom-root" class="classroom-layout animate-fade-in" data-move-url="{% url 'move_student' classroom.pk %}"
    data-move-batch-url="{% url 'move_students_batch' classroom.pk %}"
    data-clear-url="{% url 'clear_seat' classroom.pk %}" data-assign-url="{% url 'assign_student' classroom.pk %}"
    data-group-assign-url="{% url 'assign_group' classroom.pk %}"
    data-group-assign-batch-url="{% url 'assign_group_batch' classroom.pk %}"
    data-group-auto-url="{% url 'auto_group_from_reference' classroom.pk %}"
    data-group-merge-url="{% url 'merge_groups' classroom.pk %}"
    data-state-url="{% url 'classroom_state' classroom.pk %}" data-undo-url="{% url 'undo_action' classroom.pk %}"
    data-redo-url="{% url 'redo_action' classroom.pk %}" data-set-leader-url="{% url 'set_group_leader' classroom.pk %}"
    data-csrf="{{ csrf_token }}">

    <div class="zoom-controls">
        <button type="button" class="zoom-btn" onclick="zoomOut()" title="缩小">-</button>
        <span id="zoom-level">100%</span>
        <button type="button" class="zoom-btn" onclick="zoomIn()" title="放大">+</button>
    </div>

    <section class="seat-stage">
        <div class="seat-grid" id="seat-grid-container">
            {% for row_seats in seat_grid %}
            <div class="seat-row">
                {% for seat in row_seats %}
                {% if seat %}
                <div class="seat cell-{{ seat.cell_type }} {% if seat.student %}occupied{% endif %} {% if seat.student and seat.group and seat.group.leader_id == seat.student.pk %}is-leader{% endif %}"
                    data-row="{{ seat.row }}" data-col="{{ seat.col }}" data-cell-type="{{ seat.cell_type }}"
                    data-student-id="{% if seat.student %}{{ seat.student.pk }}{% endif %}">
                    {% if seat.cell_type == 'seat' %}
                    {% if seat.student %}
                    <div class="seat-content" draggable="true" data-student-id="{{ seat.student.pk }}">
                        <div class="seat-name">{{ seat.student.name }}</div>
                        {% if seat.student.score > 0 %}
                        <div class="seat-info">{{ seat.student.display_score }}分</div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="seat-info seat-coord">{{ seat.row }}-{{ seat.col }}</div>
                    {% endif %}
                    {% if seat.group %}
                    <div class="seat-group-tag">{{ seat.group.name }}</div>
                    {% endif %}
                    {% else %}
                    <div class="seat-placeholder">{{ seat.get_cell_type_display }}</div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </section>

    <aside class="side-panel">
        <div class="panel-card">
            <div class="panel-header">
                <h3>快捷操作</h3>
                <div class="panel-actions" id="shortcut-actions">
                    <button type="button" class="btn btn-secondary" id="undoBtn">撤销</button>
                    <button type="button" class="btn btn-secondary" id="redoBtn">重做</button>
                </div>
            </div>
            <div class="panel-note">快捷键：Ctrl+Z 撤销，Ctrl+Y 重做，Ctrl+C 复制，Ctrl+X 剪切，Ctrl+V 粘贴，Delete 删除，Ctrl+D
                移入暂存区，Ctrl+U 从暂存区取出。按 Ctrl/Shift 点击可多选，拖拽任一选中座位可批量移动。</div>
        </div>

        <div class="panel-card panel-tabs">
            <div class="tab-header" id="main-tab-header">
                <button type="button" class="tab-btn active" data-tab="students">学生</button>
                <button type="button" class="tab-btn" data-tab="groups">小组</button>
                <button type="button" class="tab-btn" data-tab="constraints">约束</button>
                <button type="button" class="tab-btn" data-tab="files">文件</button>
            </div>

            <div class="tab-body">
                <div class="tab-panel active" data-tab-panel="students">
                    <div class="panel-header">
                        <h3>未入座</h3>
                        <span class="panel-meta" id="unseatedCount">{{ unseated_students|length }} 人</span>
                    </div>
                    <input type="text" id="unseatedSearch" placeholder="搜索未入座学生（姓名）">
                    <div class="unseated-list">
                        {% for student in unseated_students %}
                        <div class="unseated-item" draggable="true" data-student-id="{{ student.pk }}">
                            <div>
                                <div class="unseated-name">{{ student.name }}</div>
                                <div class="unseated-info">{% if student.score %}{{ student.display_score }}分{% endif %}
                                </div>
                            </div>
                            <button type="button" class="icon-btn delete-student"
                                data-delete-url="{% url 'delete_student' classroom.pk student.pk %}">删除</button>
                        </div>
                        {% empty %}
                        <div class="empty-hint">所有学生已入座</div>
                        {% endfor %}
                    </div>
                </div>

                <div class="tab-panel" data-tab-panel="groups">
                    <div class="panel-header">
                        <h3>小组管理</h3>
                    </div>
                    <form method="post" action="{% url 'create_group' classroom.pk %}" class="inline-form" id="createGroupForm">
                        {% csrf_token %}
                        <input type="text" name="name" placeholder="小组名称" required>
                        <button type="submit" class="btn btn-primary">添加</button>
                    </form>
                    <div class="group-list" id="groupList">
                        {% for group in groups %}
                        <div class="group-item" data-group-id="{{ group.pk }}" data-group-name="{{ group.name }}">
                            <span>{{ group.name }}</span>
                            <div style="display: flex; gap: 4px;">
                                <button type="button" class="btn btn-secondary"
                                    style="padding: 2px 8px; font-size: 12px;" data-action="rename-group"
                                    data-url="{% url 'rename_group' classroom.pk group.pk %}">重命名</button>
                                <button type="button" class="btn btn-secondary"
                                    style="padding: 2px 8px; font-size: 12px;" data-action="delete-group"
                                    data-url="{% url 'delete_group' classroom.pk group.pk %}">删除</button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-hint">暂无小组</div>
                        {% endfor %}
                    </div>
                    <div class="panel-note">开启分组模式后可框选或点击多选座位，再应用分组</div>
                    <div class="tool-row">
                        <select id="groupSelect" class="group-select-control">
                            <option value="">未分组</option>
                            {% for group in groups %}
                            <option value="{{ group.pk }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-secondary" id="groupAssignToggle">分组模式</button>
                        <button type="button" class="btn btn-secondary" id="groupApplyBtn">应用到选中</button>
                        <button type="button" class="btn btn-secondary" id="groupAutoBtn"
                            data-open-modal="group-auto-config-modal">自动编组</button>
                        <button type="button" class="btn btn-secondary" id="groupClearSelectBtn">清空选中</button>
                    </div>
                    <div class="tool-row">
                        <select id="groupMergeFromSelect" class="group-select-control">
                            <option value="">来源组</option>
                            {% for group in groups %}
                            <option value="{{ group.pk }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <select id="groupMergeToSelect" class="group-select-control">
                            <option value="">目标组</option>
                            {% for group in groups %}
                            <option value="{{ group.pk }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-secondary" id="groupMergeBtn">合并组</button>
                    </div>
                </div>

                <div class="tab-panel" data-tab-panel="constraints">
                    <div class="panel-header">
                        <h3>约束管理</h3>
                    </div>
                    <form method="post" action="{% url 'create_constraint' classroom.pk %}" class="constraint-form">
                        {% csrf_token %}
                        <select name="constraint_type" required>
                            <option value="must_seat">指定座位</option>
                            <option value="forbid_seat">禁用座位</option>
                            <option value="must_row">指定行</option>
                            <option value="forbid_row">禁用行</option>
                            <option value="must_col">指定列</option>
                            <option value="forbid_col">禁用列</option>
                            <option value="must_together">指定相邻</option>
                            <option value="forbid_together">禁止相邻</option>
                        </select>
                        <select name="student_id" required>
                            {% for student in students %}
                            <option value="{{ student.pk }}">{{ student.name }}</option>
                            {% endfor %}
                        </select>
                        <select name="target_student_id">
                            <option value="">关联学生（可选）</option>
                            {% for student in students %}
                            <option value="{{ student.pk }}">{{ student.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="constraint-grid">
                            <input type="number" name="row" placeholder="行" min="1">
                            <input type="number" name="col" placeholder="列" min="1">
                            <input type="number" name="distance" placeholder="距离" min="1" value="1">
                        </div>
                        <input type="text" name="note" placeholder="备注（可选）">
                        <button type="submit" class="btn btn-primary">添加约束</button>
                    </form>
                    <div class="constraint-list">
                        {% for constraint in constraints %}
                        <div class="constraint-item">
                            <div>
                                <div class="constraint-title">{{ constraint.get_constraint_type_display }}</div>
                                <div class="constraint-desc">
                                    {{ constraint.student.name }}
                                    {% if constraint.target_student %} ↔ {{ constraint.target_student.name }}{% endif %}
                                    {% if constraint.row %} 行 {{ constraint.row }}{% endif %}
                                    {% if constraint.col %} 列 {{ constraint.col }}{% endif %}
                                    {% if constraint.distance %} 距离 {{ constraint.distance }}{% endif %}
                                </div>
                            </div>
                            <form method="post" action="{% url 'delete_constraint' classroom.pk constraint.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-secondary">删除</button>
                            </form>
                        </div>
                        {% empty %}
                        <div class="empty-hint">暂无约束</div>
                        {% endfor %}
                    </div>
                </div>

                <div class="tab-panel" data-tab-panel="files">
                    <div class="panel-header">
                        <h3>文件导入导出</h3>
                    </div>
                    <div class="tool-row" style="margin-bottom: 8px;">
                        <button type="button" class="btn btn-primary" data-open-modal="excel-import-modal">导入 Excel 成绩表</button>
                        <button type="button" class="btn btn-secondary" data-open-modal="seats-file-modal">导入/导出 .seats</button>
                        <button type="button" class="btn btn-secondary" data-open-modal="seat-layout-import-modal">导入座位表</button>
                    </div>
                    <a href="{% url 'export_group_report' classroom.pk %}" class="btn btn-secondary"
                        style="width: 100%;">导出小组登记表</a>

                    <div class="panel-header" style="margin-top: 8px;">
                        <h3>布局快照</h3>
                    </div>
                    <form method="post" action="{% url 'save_layout_snapshot' classroom.pk %}" class="inline-form">
                        {% csrf_token %}
                        <input type="text" name="snapshot_name" placeholder="例如：期中考试座位" required>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </form>
                    <div class="snapshot-list">
                        {% for snap in snapshots %}
                        <div class="snapshot-item">
                            <span>{{ snap.name }}</span>
                            <div class="snapshot-actions">
                                <a href="{% url 'load_layout_snapshot' classroom.pk snap.pk %}"
                                    class="btn btn-secondary">加载</a>
                                <form method="post" action="{% url 'delete_layout_snapshot' classroom.pk snap.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-secondary">删除</button>
                                </form>
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-hint">暂无快照</div>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>
    </aside>

    <div id="group-auto-config-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 8px;">自动编组配置</h3>
            <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 14px;">
                请选择参考小组和“无法整除”时的处理策略。</p>
            <div class="form-group" style="margin-bottom: 10px;">
                <label>参考小组</label>
                <select id="groupAutoReferenceSelect" class="group-select-control">
                    <option value="">请选择参考小组</option>
                    {% for group in groups %}
                    <option value="{{ group.pk }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 8px;">
                <label>余数处理策略</label>
                <div class="stack-form">
                    <label class="checkbox-row">
                        <input type="radio" name="group_auto_remainder_strategy" value="merge_prev">
                        最后一人与附近人/上一组编为一组
                    </label>
                    <label class="checkbox-row">
                        <input type="radio" name="group_auto_remainder_strategy" value="new_group" checked>
                        剩余人编为一组
                    </label>
                    <label class="checkbox-row">
                        <input type="radio" name="group_auto_remainder_strategy" value="skip">
                        不编组（仅整组人数）
                    </label>
                </div>
            </div>
            <label class="checkbox-row" style="margin-bottom: 8px;">
                <input type="checkbox" id="groupAutoDetectStyleCheckbox" checked>
                自动识别编组样式（竖排/横排/附近几人）
            </label>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-close-modal="group-auto-config-modal">取消</button>
                <button type="button" class="btn btn-primary" id="groupAutoConfirmBtn">开始编组</button>
            </div>
        </div>
    </div>

    <div id="seat-layout-import-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 8px;">导入座位表（Excel）</h3>
            <p style="color: var(--text-secondary); margin-bottom: 14px; font-size: 14px;">
                支持自动识别合并单元格，空白单元格按走廊处理；自动识别讲台/空位/座位，并支持手动词典覆盖识别。</p>
            <form id="seat-layout-upload-form" method="post" action="{% url 'import_layout_excel' classroom.pk %}"
                enctype="multipart/form-data" onsubmit="return handleSeatLayoutUpload(event)">
                {% csrf_token %}
                <div class="form-group">
                    <label>座位表文件</label>
                    <input type="file" name="layout_excel_file" accept=".xlsx,.xls,.xlsm" required>
                </div>
                <div class="modal-actions" style="margin-top: 12px;">
                    <button type="button" class="btn btn-secondary" data-close-modal="seat-layout-import-modal">取消</button>
                    <button type="submit" class="btn btn-primary" id="seat-layout-upload-btn">上传并识别</button>
                </div>
            </form>

            <div id="seat-layout-config" style="display: none; margin-top: 14px;">
                <input type="hidden" id="seat-layout-file-id">
                <div class="constraint-grid">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>开始行</label>
                        <input type="number" id="seat-layout-start-row" min="1">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>结束行</label>
                        <input type="number" id="seat-layout-end-row" min="1">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>姓名识别</label>
                        <label class="checkbox-row">
                            <input type="checkbox" id="seat-layout-auto-name" checked>
                            自动识别2-5位无数字文本
                        </label>
                    </div>
                </div>

                <div class="tool-row seat-layout-transform-row" style="margin-top: 4px;">
                    <button type="button" class="btn btn-secondary seat-layout-transform-btn active"
                        data-layout-transform="none" onclick="setSeatLayoutTransform('none')">原始方向</button>
                    <button type="button" class="btn btn-secondary seat-layout-transform-btn"
                        data-layout-transform="flip_ud" onclick="setSeatLayoutTransform('flip_ud')">上下翻转</button>
                    <button type="button" class="btn btn-secondary seat-layout-transform-btn"
                        data-layout-transform="flip_lr" onclick="setSeatLayoutTransform('flip_lr')">左右翻转</button>
                    <button type="button" class="btn btn-secondary seat-layout-transform-btn"
                        data-layout-transform="rotate_180" onclick="setSeatLayoutTransform('rotate_180')">180°旋转</button>
                </div>

                <div class="form-group" style="margin-bottom: 8px;">
                    <label>手动标记为“姓名”（逗号分隔）</label>
                    <input type="text" id="seat-layout-manual-names" placeholder="例如：张三,李四">
                </div>
                <div class="form-group" style="margin-bottom: 8px;">
                    <label>手动标记为“讲台”（逗号分隔）</label>
                    <input type="text" id="seat-layout-manual-podium" placeholder="例如：讲台,教师区">
                </div>
                <div class="form-group" style="margin-bottom: 8px;">
                    <label>手动标记为“空位”（逗号分隔）</label>
                    <input type="text" id="seat-layout-manual-empty" placeholder="例如：空位,留空">
                </div>
                <div class="form-group" style="margin-bottom: 8px;">
                    <label>手动标记为“走廊”（逗号分隔）</label>
                    <input type="text" id="seat-layout-manual-aisle" placeholder="例如：走廊,过道">
                </div>
                <label class="checkbox-row">
                    <input type="checkbox" id="seat-layout-replace-students">
                    导入前清空现有学生（会同时清空与学生相关约束）
                </label>

                <div class="tool-row" style="margin-top: 10px;">
                    <button type="button" class="btn btn-secondary" id="seat-layout-preview-btn"
                        onclick="refreshSeatLayoutPreview()">更新预览</button>
                    <button type="button" class="btn btn-primary" id="seat-layout-confirm-btn"
                        onclick="confirmSeatLayoutImport()">确认导入</button>
                    <button type="button" class="btn btn-secondary" data-close-modal="seat-layout-import-modal">关闭</button>
                </div>

                <div id="seat-layout-preview-meta" class="panel-note" style="margin-top: 8px;"></div>
                <div class="seat-layout-preview-wrap">
                    <div>
                        <h4 style="font-size: 13px; margin: 8px 0;">前2排预览</h4>
                        <div id="seat-layout-front-preview" class="table-container"></div>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; margin: 8px 0;">后2排预览</h4>
                        <div id="seat-layout-back-preview" class="table-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="excel-import-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 8px;">导入 Excel 成绩表</h3>
            <p style="color: var(--text-secondary); margin-bottom: 14px; font-size: 14px;">
                上传包含“姓名”列的 Excel 文件。若“总分/学生总分”列可识别，会自动导入；否则会进入列映射步骤。</p>
            <form id="excel-import-form" method="post" action="{% url 'import_students' classroom.pk %}"
                enctype="multipart/form-data" onsubmit="return handleImportSubmit(event)">
                {% csrf_token %}
                <div class="form-group">
                    <label>Excel 文件</label>
                    <input type="file" name="excel_file" accept=".xlsx,.xls" required>
                </div>
                <label class="checkbox-row">
                    <input type="checkbox" name="clear_existing" value="1">
                    清空现有学生后再导入
                </label>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-close-modal="excel-import-modal">取消</button>
                    <button type="submit" class="btn btn-primary">开始导入</button>
                </div>
            </form>
        </div>
    </div>

    <div id="seats-file-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 8px;">导入/导出 .seats 文件</h3>
            <div class="modal-block">
                <p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 14px;">
                    导入会用文件内容覆盖当前班级布局、学生、小组与约束。</p>
                <form method="post" action="{% url 'import_seats_file' classroom.pk %}" enctype="multipart/form-data"
                    class="stack-form">
                    {% csrf_token %}
                    <input type="file" name="seats_file" accept=".seats,application/json" required>
                    <button type="submit" class="btn btn-primary">导入 .seats</button>
                </form>
            </div>
            <div class="modal-divider"></div>
            <div class="modal-block">
                <p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 14px;">
                    导出当前班级完整快照，后续可直接导回系统。</p>
                <a href="{% url 'export_seats_file' classroom.pk %}" class="btn btn-secondary">导出 .seats</a>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-close-modal="seats-file-modal">关闭</button>
            </div>
        </div>
    </div>

    <!-- Import Mapping Modal -->
    <div id="import-mapping-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 8px;">匹配数据</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                我们需要你协助识别文件中的数据列。请选择标题行以及对应的列。</p>

            <div class="form-group">
                <label>数据起始行 (标题行)</label>
                <input type="number" id="import-start-row" value="1" min="1" class="form-control">
                <small style="color: var(--text-secondary); font-size: 12px;">请输入包含列名（如“姓名”、“总分”或“学生总分”）的那一行行号</small>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label>姓名列</label>
                    <select id="import-name-col" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label>总分列 (可选)</label>
                    <select id="import-score-col" class="form-control">
                        <option value="">不导入分数</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>识别预览 (前2位学生)</label>
                <div id="import-preview-area" class="table-container">
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">请先选择列以查看预览</div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmImportMapping()">确认导入</button>
            </div>
        </div>
    </div>
    <!-- Context Menu -->
    <div id="seat-context-menu" class="context-menu">
        <button type="button" class="menu-item" id="ctx-set-leader">任命为组长</button>
    </div>
</div>

<script src="{% static 'js/classroom.js' %}?v={{ request.session.session_key|default:'dev' }}"></script>
<script>
    function startTour() {
        const switchRibbon = (tabKey) => {
            const tab = document.querySelector(`.ribbon-tab[data-ribbon-tab="${tabKey}"]`);
            if (tab) tab.click();
        };

        const driver = window.driver.js.driver({
            showProgress: true,
            animate: true,
            doneBtnText: '开始使用',
            nextBtnText: '下一步',
            prevBtnText: '上一步',
            steps: [
                {
                    element: '.header-content',
                    popover: {
                        title: '欢迎使用 不想排座位 智能排座系统',
                        description: '这是一个简单而强大的排座工具。让我们花一分钟熟悉一下基本操作吧。'
                    }
                },
                {
                    element: '.seat-stage',
                    popover: {
                        title: '排座区域',
                        description: '这里显示当前的座位布局。您可以直接拖拽学生进行位置交换，或点击空位查看详细信息。'
                    }
                },
                {
                    element: '#shortcut-actions',
                    popover: {
                        title: '后悔药',
                        description: '操作失误不用担心，这里可以随时撤销 (Ctrl+Z) 或重做 (Ctrl+Y) 您的最后一步操作。'
                    }
                },
                {
                    element: '#main-tab-header',
                    popover: {
                        title: '多功能面板',
                        description: '在这里切换不同功能：<br>• <b>学生</b>：管理未入座学生<br>• <b>小组</b>：创建和管理学习小组<br>• <b>约束</b>：设置固定座位或互斥规则<br>• <b>文件</b>：导入导出数据与快照'
                    }
                },
                {
                    element: '.tab-panel[data-tab-panel="groups"]',
                    popover: {
                        title: '小组管理',
                        description: '切换到“小组”标签页，您可以创建学习小组。开启“分组模式”后，框选多个座位即可批量分配小组。'
                    },
                    onHighlightStarted: (element) => {
                        document.querySelector('.tab-btn[data-tab="groups"]').click();
                    }
                },
                {
                    element: '#btn-open-excel-import-modal',
                    popover: {
                        title: '班级名单导入',
                        description: '点击这里打开 Excel 导入窗口，上传后可批量导入学生数据，并按提示完成列映射。'
                    },
                    onHighlightStarted: (element) => {
                        switchRibbon('file');
                        document.querySelector('.tab-btn[data-tab="files"]').click();
                    }
                },
                {
                    element: 'form[action*="save_layout_snapshot"]',
                    popover: {
                        title: '布局快照系统',
                        description: '保存当前座位布局为快照，随时一键恢复。适用于保存考试座位、日常座位等不同方案。'
                    },
                    onHighlightStarted: (element) => {
                        document.querySelector('.tab-btn[data-tab="files"]').click();
                    }
                },
                {
                    element: '#btn-auto-arrange',
                    popover: {
                        title: '自动排座',
                        description: '点击这里可以使用多种算法自动生成座位表，例如按成绩排序或确保小组均衡。'
                    },
                    onHighlightStarted: () => {
                        switchRibbon('home');
                    }
                },
                {
                    element: '#btn-layout-editor',
                    popover: {
                        title: '布局自定义',
                        description: '需要修改教室形状？点击这里可以自由添加座位、过道，调整教室大小。'
                    },
                    onHighlightStarted: () => {
                        switchRibbon('view');
                    }
                },
                {
                    element: '#btn-export',
                    popover: {
                        title: '导出结果',
                        description: '满意后，点击这里导出一份精美的 Excel 座位表，直接打印使用。'
                    },
                    onHighlightStarted: () => {
                        switchRibbon('file');
                    }
                },
                {
                    element: '#btn-fullscreen',
                    popover: {
                        title: '沉浸式体验',
                        description: '点击全屏按钮，让排座界面充满整个屏幕，获得更大的操作空间。'
                    },
                    onHighlightStarted: () => {
                        switchRibbon('view');
                    }
                },
                {
                    element: '.zoom-controls',
                    popover: {
                        title: '视图缩放',
                        description: '座位太多看不全？使用这里或者按住 Ctrl 滚动鼠标滚轮来缩放视图。'
                    }
                }
            ],
            onDestroyStarted: () => {
                if (!driver.hasNextStep() || confirm('确定要结束教程吗？')) {
                    driver.destroy();
                    localStorage.setItem('seat_app_tour_seen', 'true');
                    // 教程结束后重置滚动位置
                    window.scrollTo(0, 0);
                    document.documentElement.scrollTop = 0;
                    document.body.scrollTop = 0;
                }
            },
        });

        driver.drive();
    }

    function toggleFullScreen() {
        const doc = document;
        const root = document.documentElement;
        const isFullscreen = doc.fullscreenElement || doc.webkitFullscreenElement || doc.mozFullScreenElement || doc.msFullscreenElement;
        if (!isFullscreen) {
            const enter = root.requestFullscreen || root.webkitRequestFullscreen || root.mozRequestFullScreen || root.msRequestFullscreen;
            if (enter) {
                enter.call(root).catch(() => { });
            }
            return;
        }
        const exit = doc.exitFullscreen || doc.webkitExitFullscreen || doc.mozCancelFullScreen || doc.msExitFullscreen;
        if (exit) {
            exit.call(doc).catch(() => { });
        }
    }

    let currentScale = 1.0;
    const gridContainer = document.getElementById('seat-grid-container');
    const zoomLevelDisplay = document.getElementById('zoom-level');

    function updateZoom() {
        if (!gridContainer) return;
        // Use CSS zoom property which handles layout re-flow and scrolling automatically
        // This is non-standard but works well in WebKit (Chrome/Safari)
        gridContainer.style.zoom = currentScale;

        if (zoomLevelDisplay) {
            zoomLevelDisplay.textContent = `${Math.round(currentScale * 100)}%`;
        }
    }

    function zoomIn() {
        currentScale = Math.min(currentScale + 0.1, 2.0);
        updateZoom();
    }

    function zoomOut() {
        currentScale = Math.max(currentScale - 0.1, 0.5);
        updateZoom();
    }

    // Mouse wheel zoom
    const stage = document.querySelector('.seat-stage');
    if (stage) {
        stage.addEventListener('wheel', function (e) {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                if (e.deltaY < 0) zoomIn();
                else zoomOut();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const hasSeenTour = localStorage.getItem('seat_app_tour_seen');
        if (!hasSeenTour) {
            startTour();
        }
    });
</script>
{% endblock %}
